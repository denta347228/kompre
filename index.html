<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<title>Resemble.js : Image analysis</title>
		<meta name="description" content="">
		<meta name="viewport" content="width=device-width">
		<link rel="stylesheet" href="libs/twitter-bootstrap/bootstrap.min.css">
		<link rel="stylesheet" href="demoassets/resemble.css?v1">
	</head>
	<body>
		<div class="container">
			<header>
				<div class="page-header">
					<h1>Resemble.js : Image analysis and comparison</h1>
				</div>
			</header>

			<section role="main">
				<div class="row">
					<div class="span12">
						<div class="row">
							<div class="span12">
								<p id="responseContainer"></p>
							</div>
						</div>
						<div class="row">
							<div class="span6">
								<div id="dropzone1" class="small-drop-zone">
									Drop first image
								</div>
								<div id="dropzone2" class="small-drop-zone">
									Drop second image
								</div>
							</div>
							<div class="span6">
								<h2>Compare two images?</h2>
								<p>
									Drop two images on the boxes to the left.  The box below will show a generated 'diff' image, pink areas show mismatch.  This example best works with two very similar but slightly different images.  Try for yourself!
								</p>
								<p>
								Don't have any images to compare?
								<br />
								<br />
								<button class="btn" id="example-images">Use example images</button>
								<br />
								<br />
								<button class="btn" id="example-images-alpha">Use example images with alpha</button>
								</p>
								<div id="image-diff" class="small-drop-zone">
									Diff will appear here.
								</div>
								<br/>

								<div class="btn-group buttons" style="display:none">
									<button class="btn" id="raw">Ignore nothing</button>
									<button class="btn active" id="less">Ignore less</button>
									<button class="btn" id="colors">Ignore colors</button>
									<button class="btn" id="antialiasing">Ignore antialiasing</button>
									<button class="btn" id="alpha">Ignore alpha</button>
								</div>

								<br/>
								<br/>
								<div class="btn-group buttons" style="display:none">
									<button class="btn active" id="original-size">Use original size</button>
									<button class="btn" id="same-size">Scale to same size</button>
								</div>

								<div class="btn-group buttons" style="display:none">
									<button class="btn active" id="pink">Pink</button>
									<button class="btn" id="yellow">Yellow</button>
								</div>
								<br/>
								<br/>

								<div class="btn-group buttons" style="display:none">
									<button class="btn active" id="flat">Flat</button>
									<button class="btn" id="movement">Movement</button>
									<button class="btn" id="flatDifferenceIntensity">Flat with diff intensity</button>
									<button class="btn" id="movementDifferenceIntensity">Movement with diff intensity</button>
									<button class="btn" id="diffOnly">Diff portion from the input</button>
								</div>
								<br/>
								<br/>

								<div class="btn-group buttons" style="display:none">
									<button class="btn active" id="opaque">Opaque</button>
									<button class="btn" id="transparent">Transparent</button>
								</div>
								<br/>
								<br/>

								<div class="btn-group buttons" style="display:none">
									<div class="row">
										<div class="span1">
											<label>Left</label>
											<input type="number" class="input-mini" id="bounding-box-x1" value="100" />
										</div>
										<div class="span1">
											<label>Top</label>
											<input type="number" class="input-mini" id="bounding-box-y1" value="100" />
										</div>
										<div class="span1">
											<label>Right</label>
											<input type="number" class="input-mini" id="bounding-box-x2" value="400" />
										</div>
										<div class="span1">
											<label>Bottom</label>
											<input type="number" class="input-mini" id="bounding-box-y2" value="300" />
										</div>
										<div class="span2">
											<label>&nbsp;</label>
											<button class="btn" id="boundingBox">Set bounding box</button>
										</div>
									</div>
								</div>

								<br/>
								<br/>

								<div class="btn-group buttons" style="display:none">
									<div class="row">
										<div class="span1">
											<label>Left</label>
											<input type="number" class="input-mini" id="ignored-box-x1" value="120" />
										</div>
										<div class="span1">
											<label>Top</label>
											<input type="number" class="input-mini" id="ignored-box-y1" value="200" />
										</div>
										<div class="span1">
											<label>Right</label>
											<input type="number" class="input-mini" id="ignored-box-x2" value="400" />
										</div>
										<div class="span1">
											<label>Bottom</label>
											<input type="number" class="input-mini" id="ignored-box-y2" value="250" />
										</div>
										<div class="span2">
											<label>&nbsp;</label>
											<button class="btn" id="ignoredBox">Set ignored box</button>
										</div>
									</div>
								</div>

								<br/>
								<br/>

								<div class="btn-group buttons" style="display:none">
									<div class="row">
										<div class="span1">
											<label>Red</label>
											<input type="number" class="input-mini" id="ignored-color-r" min="0" max="255" value="255" />
										</div>
										<div class="span1">
											<label>Green</label>
											<input type="number" class="input-mini" id="ignored-color-g" min="0" max="255" value="0" />
										</div>
										<div class="span1">
											<label>Blue</label>
											<input type="number" class="input-mini" id="ignored-color-b" min="0" max="255" value="0" />
										</div>
										<div class="span1">
											<label>Alpha</label>
											<input type="number" class="input-mini" id="ignored-color-a" min="0" max="255" value="255" />
										</div>
										<div class="span2">
											<label>&nbsp;</label>
											<button class="btn" id="ignoredColor">Set ignored color</button>
										</div>
									</div>
								</div>

								<br/>
								<br/>
								<div id="diff-results" style="display:none;">
									<p>
										<strong>The second image is <span id="mismatch"></span>% different compared to the first.
										<span id="differentdimensions" style="display:none;">And they have different dimensions.</span></strong>
									</p>
									<p>
										Use the buttons above to change the comparison algorithm.  Perhaps you don't care about color? Annoying antialiasing causing too much noise?  Resemble.js offers multiple comparison options.
									</p>
								</div>

								<p id="thesame" style="display:none;">
									<strong>These images are the same!</strong>
								</p>
							</div>
						</div>
					</div>
				</div>
			</section>

			<footer class="footer">
				<p>	
					Created by <a href="https://github.com/jamescryer" target="_blank">James Cryer</a> and the Huddle development team.
				</p>
				<p>
					The image used in the comparison example was created by <a href="https://twitter.com/Shadowise" target="_blank">Daniel Rajendran</a>
				</p>
			</footer>
		</div>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
		<script src="resemble.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
		<script src="demoassets/main.js"></script>

		<script>
			// Select dropzones
			const dropzone1 = document.getElementById('dropzone1');
			const dropzone2 = document.getElementById('dropzone2');

			// Track uploaded images
			let hasImage1 = false;
			let hasImage2 = false;

			// Function to handle image drop
			async function handleDrop(event, dropzone) {
				event.preventDefault();
				
				const files = event.dataTransfer.files;

				if (files.length > 0) {
					const img = document.createElement('img');
					const reader = new FileReader();

					reader.onload = async function(e) {

						img.src = e.target.result;
						
						dropzone.appendChild(img);
						if (dropzone === dropzone1) {
							hasImage1 = true;
						} else if (dropzone === dropzone2) {
							hasImage2 = true;
						}
						checkImagesUploaded();
					};

					const imageRender = files[0].type === 'application/pdf' ? await convertPdfToImage(files[0], 'file') : files[0];

					reader.readAsDataURL(imageRender);
				}
			}

			function base64ToFile(base64Data, filename) {
				const arr = base64Data.split(',');
				const mime = arr[0].match(/:(.*?);/)[1]; // Get the MIME type
				const bstr = atob(arr[1]); // Decode base64
				let n = bstr.length;
				const u8arr = new Uint8Array(n);

				while (n--) {
					u8arr[n] = bstr.charCodeAt(n);
				}

				return new File([u8arr], filename, { type: mime });
			}

			// Check if both dropzones have images
			function checkImagesUploaded() {
				if (hasImage1 && hasImage2) {
					const image1 = document.querySelector('#dropzone1 img');
					const image2 = document.querySelector('#dropzone2 img');
					
					if (image1 && image2) {
						const formData = new FormData();

						const file1 = base64ToFile(image1.src, 'image1.png'); // Change filename as needed
						const file2 = base64ToFile(image2.src, 'image2.png'); // Change filename as needed

						formData.append('file1', file1);
						formData.append('file2', file2);

						fetch('http://127.0.0.1:5000/upload', {
							method: 'POST',
							body: formData,
						})
						.then(response => {
							if (!response.ok) {
								alert('ALERT Network response was not ok');
								throw new Error('Network response was not ok');
							}
							return response.json();
						})
						.then(data => {
							const responseContainer = document.getElementById('responseContainer');

							// Clear previous content, if any
							responseContainer.innerHTML = ''; 

							// Set the inner HTML to the converted content
							responseContainer.innerHTML = data.data;
						})
						.catch((error) => {
							console.error('Error:', error);
						});
					} else {
						console.log('No image found in the dropzone.');
					}
				}
			}

			// Prevent default behavior for drag over
			function handleDragOver(event) {
				event.preventDefault();
			}

			// Add event listeners
			dropzone1.addEventListener('dragover', handleDragOver);
			dropzone1.addEventListener('drop', (event) => handleDrop(event, dropzone1));
			dropzone2.addEventListener('dragover', handleDragOver);
			dropzone2.addEventListener('drop', (event) => handleDrop(event, dropzone2));
		</script>
	</body>
</html>
